<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>requests</title>
    <link rel="stylesheet" th:href="@{/css/user/profind/find_info.css}">
    <link rel="stylesheet" th:href="@{/css/main/common.css}">
    <link rel="stylesheet" th:href="@{/css/layout/header.css}">
    <link rel="stylesheet" th:href="@{/css/user/req_list/received_req_info.css}">
    <link rel="stylesheet" th:href="@{/css/user/mypage/certify.css}">
    <link rel="stylesheet" th:href="@{/css/user/upload/receiveform.css}">
    <link rel="stylesheet" th:href="@{/css/user/mypage/edit.css}">
    <link rel="stylesheet" th:href="@{/css/user/mypage/withdrawmodal.css}">
    <link rel="stylesheet" th:href="@{/css/layout/footer.css}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR&display=swap" rel="stylesheet">
<!--    <link rel="stylesheet" href="/static/css/common(2)/font.css">-->
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>
    <div class="request-header">
        <div class="request-header-inner">
            <div class="service-title">
                <h2 th:text="${userUpload.userUploadTitle}"></h2>
            </div>
            <div class="received-date">
                <div class="date-badge">올린 날짜</div>
                <div class="date" th:text="${userUpload.userUploadDate}">2024.06.28</div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="page-body">
            <div class="info">
                <div class="request-info">
                    <!-- 회원 정보 -->
                    <div class="pro-info">
                        <div class="pro-pic">
                            <img src="https://dmmj3ljielax6.cloudfront.net/upload/requestForm/25f0e364-93ad-4d49-b710-3a2f073dc547.svg">
                        </div>
                        <div class="pro-name-rate">
                            <input type="hidden" name="userId" th:value="${userUpload.userId}">
                            <div class="pro-name user-name" th:text="${userUpload.userName}"></div>
                            <div class="service-address">
                                <div class="service-name" th:text="${userUpload.serviceName}">주택 건축</div>
                                <div class="address">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMCAyMGgyMFYwSDB6Ii8+PGcgc3Ryb2tlPSIjNzM3MzczIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggZD0iTTE2LjIxOCA3LjI3NGMwIDQuOTQzLTUuODMzIDEwLjIyNi01LjgzMyAxMC4yMjZTNC41NSAxMi41NDIgNC41NSA3LjI3NGMwLTMuMDk3IDIuNjEyLTUuNjA3IDUuODM0LTUuNjA3IDMuMjIxIDAgNS44MzMgMi41MSA1LjgzMyA1LjYwN3oiLz48cGF0aCBkPSJNMTIuNjI4IDcuOTE3YTIuMDg0IDIuMDg0IDAgMTEtNC4xNjctLjAwMSAyLjA4NCAyLjA4NCAwIDAxNC4xNjcgMHoiLz48L2c+PC9nPjwvc3ZnPg==" alt="">
                                    <span th:text="${userUpload.region}+' '+${userUpload.city}">경북 포항시</span>
                                </div>
                            </div>
                            <div class="pro-rate">
                                <div class="rate">
                                    <div class="pro-rate-title">별점</div>
                                    <div class="pro-rate-info">
                                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo=" alt="">
                                        <span th:text="${userUpload.userStarRate}">4.5</span>
                                        <span class="count" th:text="'(' + ${userReviewCnt} + ')'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 요청 내용 -->
                    <div class="request-content-body">
                        <div class="request-content">
                            <h2>요청 내용</h2>
                            <div th:text="${userUpload.userUploadContent}"></div>
                        </div>
                    </div>
                    <!-- 사진 -->
                    <div class="pro-photos">
                        <div class="photos-container">
                            <h2>사진</h2>
                            <div><ul class="image-veiwer">
                                <li th:each="userUploadFile : ${userUploadFiles}">
                                    <img th:src="${userUploadFile.userUploadFileRoute}" alt="이미지">
                                    <!--                                    여기 부분 사진 받아오기-->
                                </li>
                            </ul></div>
                        </div>
                    </div>
                    <!-- 리뷰 -->
                    <div class="reviews">
                        <h2>리뷰</h2>
                        <div class="review-list">
                            <div class="summary">
                                <div class="avg" th:text="${userUpload.userStarRate}"></div>
                                <div class="review-star">
                                    <ul>
                                        <li>
                                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo=" alt="">
                                        </li>
                                    </ul>
                                    <div th:text="${userReviewCnt} + '개의 리뷰'">15개의 리뷰</div>
                                </div>
                            </div>
                            <div>
                                <ul class="review-container">

                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="request-price-side">
                <div class="side-wrapper">
                    <span th:text="${userUpload.userName}">회원 이름</span>
                    <span>에게 서비스를 제공해보세요</span>
                    <div class="request-price">
                        <span th:text="${userUpload.userUploadPay}-${userUpload.userUploadPayRange}">10000원</span>
                        <span>~</span>
                        <span id="plusUserUploadPay" th:text="${userUpload.userUploadPay}+${userUpload.userUploadPayRange}">30000원</span>
                    </div>
                    <div class="accept-cancle-btn">
                        <button th:if="${checkRequest == 0}"
                                type="button" id="btn-modal" class="btn-accept btn-cancle">서비스 견적드리기</button>
                        <button
                                th:unless="${checkRequest == 0}"
                                type="button"
                                class="btn-accept" style="background-color: #9aa0a6">이미 견적을 드렸습니다
                        </button>
                    </div>
                </div>
            </div>

             </div>
         </div>
     </div>

<div id="modal" class="container" style="margin-top: 0 !important;">
    <div class="box-container">
        <div class="box-header">견적서</div>
        <div class="box-content">
            <div class="description">
                <div class="pro-name user-name" th:text="${proLocation.proName}">주현제</div>
                <div class="address" style="margin-top: 10px;">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMCAyMGgyMFYwSDB6Ii8+PGcgc3Ryb2tlPSIjNzM3MzczIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggZD0iTTE2LjIxOCA3LjI3NGMwIDQuOTQzLTUuODMzIDEwLjIyNi01LjgzMyAxMC4yMjZTNC41NSAxMi41NDIgNC41NSA3LjI3NGMwLTMuMDk3IDIuNjEyLTUuNjA3IDUuODM0LTUuNjA3IDMuMjIxIDAgNS44MzMgMi41MSA1LjgzMyA1LjYwN3oiLz48cGF0aCBkPSJNMTIuNjI4IDcuOTE3YTIuMDg0IDIuMDg0IDAgMTEtNC4xNjctLjAwMSAyLjA4NCAyLjA4NCAwIDAxNC4xNjcgMHoiLz48L2c+PC9nPjwvc3ZnPg=="
                         alt="">
                    <span th:text="${proLocation.region} + ' ' + ${proLocation.city}"></span>
                </div>
            </div>
            <form th:action="@{/pro/sendProRequest}" name="pro_receviemodal" th:object="${proRequest}"
                  id="proreceviemodal" class="pro" method="post">
                <input type="hidden" th:value="${userUpload.userUploadId}" name="userUploadId">
                <div class="title">견적을 보내면 회원이 수락시 연락처가 공개됩니다.</div>
                <div class="col underline">
                    <label for="pro_receive_modal" class="fontSize15 label">견적 금액 (원)</label>
                    <input type="number" id="pro_receive_modal" th:field="*{proRequestPay}" name="proRequestPay" class="form-control"
                           placeholder="정확한금액을 입력하세요">
                </div>
                <div class="">
                    <textarea class="textarea" maxlength="65536" style="width:100%;height:300px" th:field="*{proRequestContent}"
                              placeholder="견적과 서비스에 대한 내용을 구체적으로 적으실 수록 회원의 수락률이 높습니다."></textarea>
                </div>


                <!--모달 창 닫음 -->
                <button type="button" class="btn pro-btn"  onclick="proRecevieModalSubmit()">견적 보내기</button>
                <button type="button" id="close-modal"  class="btn pro-btn">취소</button>
            </form>
        </div>
    </div>
</div>
<div th:replace="~{/layout/footer :: footer}"></div>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    function formatDate(dateString) {
        const now = new Date();
        const commentDate = new Date(dateString); // 문자열을 Date 객체로 변환

        const nowYear = now.getFullYear();
        const nowMonth = now.getMonth();
        const nowDate = now.getDate();

        const commentYear = commentDate.getFullYear();
        const commentMonth = commentDate.getMonth();
        const commentDateDate = commentDate.getDate();

        let displayText = "";

        // 년, 월, 일이 모두 같은 경우 "오늘"로 표시
        // if (nowYear === commentYear && nowMonth === commentMonth && nowDate === commentDateDate) {
        //     displayText = "오늘";
        // } else {
        // 그 외의 경우, 정해진 포맷으로 표시
        const yy = commentYear.toString().slice(-2); // 마지막 두 자리를 가지고 옴.
        const M = commentMonth + 1; // 월은 0부터 시작하므로 1을 더해줍니다.
        const d = commentDateDate;
        const HH = commentDate.getHours().toString().padStart(2, '0');
        const mm = commentDate.getMinutes().toString().padStart(2, '0'); // 두자리 수 일 때 앞에 0을 붙임.

        displayText = `${yy}.${M}.${d}`;
        // }
        return displayText;
    }

    // 리뷰 가져오기
    $(document).ready(function () {
        console.log('여기는 됨')
        // let boardId = document.querySelector('input[name="boardId"]').value;
        let userId = $('input[name="userId"]').val();
        console.log(userId)
        getReview(userId);
    })

    function getReview(userId) {
        $.ajax({
            method : 'get',
            url : '/userReviews/' + userId,
            success : function(data) {
                let reviewListArea = $('.review-container')

                reviewListArea.empty();

                data.forEach(function(review) {
                    let reviewDate = formatDate(review.userReviewDate);


                    // 종합적으로 뿌려줄 html
                    let reviewElement = `<li>
                                        <div class="reviewr-name">
                                            <span>${review.proName}</span>
                                        </div>
                                        <div class="service-score">
                                            <p>${review.userReviewTitle}</p>
                                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo=" alt="">
                                            <span>${review.userReviewRate}</span>
                                        </div>
                                        <div class="review-content">
                                            <p>${review.userReviewContent}</p>
                                        </div>
                                        <div class="review-date">
                                            <span class="date">${reviewDate}</span>
                                        </div>
                                    </li>`

                    reviewListArea.append(reviewElement);
                })
            },
            error : function(data) {
                console.error(data, "불러오기 실패");
            }
        })
    }

//     모달
    const modal=document.getElementById("modal")

    function modalOn(){
      modal.style.display="flex"
    }
    function modalOff() {
      modal.style.display = "none"
    }
    // 모달창 보임
    const btnModal = document.getElementById("btn-modal")
    btnModal.addEventListener("click", e => {
      modalOn()
    })
    // 모달창 닫음
    const closeModal = document.getElementById("close-modal")
    closeModal.addEventListener("click", e => {
      modalOff()
    })
    function proRecevieModalSubmit(){
        // value는 string으로 값이넘어가서, 숫자비교를 위해 형변환을 해준다
        var proRequestPay = parseInt(document.querySelector('input[name="proRequestPay"]').value); //전문가 입력한 값

        var plusUserUploadPay =parseInt(document.getElementById('plusUserUploadPay').textContent)//회원이 올린값 중 큰값


        // 보유캐시보다 전문가에게 요청하는 금액이 크면 alert,입력창을 비워준다
        if(plusUserUploadPay<proRequestPay){
            console.log(proRequestPay)
            console.log(plusUserUploadPay)
            document.getElementById('proRequestContent').value ="";
            document.querySelector('input[name="proRequestPay"]').value = "";
            alert("회원이 원하는 금액보다 입력 금액이 많습니다.");
        }

        else {
            document.getElementById('proreceviemodal').submit();
        }

    }



</script>
</html>