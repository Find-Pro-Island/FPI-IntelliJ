<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>requests</title>
    <link rel="stylesheet" th:href="@{/css/user/req_list/received_req_info.css}">
    <link rel="stylesheet" th:href="@{/css/user/req_list/cancle_declare.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" th:href="@{/css/main/common.css}">
    <link rel="stylesheet" th:href="@{/css/layout/header.css}">
    <link rel="stylesheet" th:href="@{/css/layout/footer.css}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR&display=swap" rel="stylesheet">
    <!--    <link rel="stylesheet" th:href="/static/css/common(2)/font.css">-->
    <style>
        .hidden {
            height: 100%;
            min-height: 100%;
            overflow: hidden !important;
            touch-action: none;
        }
    </style>
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>

<div class="request-header">
    <div class="request-header-inner">
        <div class="service-title">
            <h2 th:text="${proRequest.userUploadTitle}"></h2>
        </div>
        <div class="received-date">
            <div class="date-badge">받은 날짜</div>
            <div class="date" th:text="${proRequest.proRequestDate}"></div>
        </div>
    </div>
</div>
<div class="container">
    <div class="page-body">
        <div class="info">
            <div class="request-info">
                <!-- 전문가 정보 -->
                <div class="pro-info">
                    <div class="pro-pic">
                        <img src="https://dmmj3ljielax6.cloudfront.net/upload/requestForm/25f0e364-93ad-4d49-b710-3a2f073dc547.svg">
                    </div>
                    <div class="pro-name-rate">
                        <input type="hidden" name="proId" th:value="${proRequest.proId}">
                        <div class="pro-name" th:text="${proRequest.proName}">FPI 건축</div>
                        <div class="service-address">
                            <div class="service-name" th:text="${proRequest.serviceName}">주택 건축</div>
                            <div class="address">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMCAyMGgyMFYwSDB6Ii8+PGcgc3Ryb2tlPSIjNzM3MzczIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggZD0iTTE2LjIxOCA3LjI3NGMwIDQuOTQzLTUuODMzIDEwLjIyNi01LjgzMyAxMC4yMjZTNC41NSAxMi41NDIgNC41NSA3LjI3NGMwLTMuMDk3IDIuNjEyLTUuNjA3IDUuODM0LTUuNjA3IDMuMjIxIDAgNS44MzMgMi41MSA1LjgzMyA1LjYwN3oiLz48cGF0aCBkPSJNMTIuNjI4IDcuOTE3YTIuMDg0IDIuMDg0IDAgMTEtNC4xNjctLjAwMSAyLjA4NCAyLjA4NCAwIDAxNC4xNjcgMHoiLz48L2c+PC9nPjwvc3ZnPg=="
                                     alt="">
                                <span th:text="${proRequest.region}+' '+${proRequest.city}">경북 포항시</span>
                            </div>
                        </div>
                        <div class="pro-rate">
                            <div class="hired-cnt">
                                <div class="pro-rate-title">고용 횟수</div>
                                <div class="pro-rate-info" th:text="${proRequest.empCnt}+'회'"></div>
                            </div>
                            <div class="rate">
                                <div class="pro-rate-title">별점</div>
                                <div class="pro-rate-info">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo="
                                         alt="">
                                    <span th:text="${proRequest.proStarRate}">4.5</span>
                                    <span class="count" th:text="'(' + ${proReviewCnt} + ')'"></span>
                                    <!-- 여기 어떻게 해야하는지? -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 전문가가 보낸 요청 내용 -->
                <div class="request-content-body">
                    <div class="request-content">
                        <h2>요청 내용</h2>
                        <div th:text="${proRequest.proRequestContent}"></div>
                    </div>
                    <!-- 경력 및 수상 내역 -->

                    <div class="carrer-body">
                        <div class="carrer-header">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Ik0xMi42OCAzYzIuMTMzIDAgMy44OTggMS41NSAzLjg5OCAzLjUxMmwtLjAwMS40OTloNC4yODNjLjMyMSAwIC41ODcuMjQyLjYzMy41NTZsLjAwNy4wOTZ2MTEuNjg1YzAgLjM2LS4yODYuNjUyLS42NC42NTJIMy4xNGEuNjQ2LjY0NiAwIDAgMS0uNjQtLjY1MlY3LjY2M2MwLS4zNi4yODYtLjY1MS42NC0uNjUxbDQuMjgyLS4wMDF2LS40OTljMC0xLjkgMS42NTMtMy40MTIgMy42OTMtMy41MDdMMTEuMzIgM3pNNy45MTQgMTQuODM0SDMuNzc5djMuODYySDIwLjIydi0zLjg2MmgtNC4xMzV2Ljg1M2MwIC4zNi0uMjg2LjY1MS0uNjQuNjUxYS42NDQuNjQ0IDAgMCAxLS42MzItLjU1NWwtLjAwNy0uMDk2LS4wMDEtLjg1M0g5LjE5NHYuODUzYzAgLjM2LS4yODYuNjUxLS42NC42NTFhLjY0NC42NDQgMCAwIDEtLjYzMy0uNTU1bC0uMDA2LS4wOTYtLjAwMS0uODUzek0yMC4yMiA4LjMxNUgzLjc4bC0uMDAxIDUuMjE1aDQuMTM1di0uODUyYzAtLjM2LjI4Ny0uNjUyLjY0LS42NTIuMzIyIDAgLjU4OC4yNDEuNjMzLjU1NmwuMDA3LjA5NnYuODUyaDUuNjExdi0uODUyYzAtLjM2LjI4Ny0uNjUyLjY0LS42NTIuMzIyIDAgLjU4OC4yNDEuNjM0LjU1NmwuMDA2LjA5NnYuODUyaDQuMTM1VjguMzE1em0tNy41NC00LjAxMWgtMS4zNmMtMS40NjUgMC0yLjYxOCAxLjAxMi0yLjYxOCAyLjIwOHYuNWg2LjU5NnYtLjVjMC0xLjE0OC0xLjA2My0yLjEyNy0yLjQ0NC0yLjIwM2wtLjE3NC0uMDA1eiIgZmlsbD0iIzAwQzdBRSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo="
                                 alt="">
                            <h3>경력</h3>
                        </div>
                        <div class="carrer-content">
                            <ul>
                                <li th:each="item : ${careerInfo}" th:text="${item.award}"></li>
                            </ul>
                        </div>
                    </div>
                    <!-- 자격증 -->
                    <!-- 여기 다시 짜야함-->
                    <div class="certificate-image">
                        <h2>자격증 및 기타 서류</h2>
                        <ul class="image-veiwer">
                            <li th:each="proCardInfoFile : ${proCardInfoFiles}">
                                <img th:src="${proCardInfoFile.cardInfoFileRoute}" alt="이미지">
                                <!--                                    여기 부분 사진 받아오기-->
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 사진 -->
                <!-- 리뷰 -->
                <div class="reviews">
                    <h2>리뷰</h2>
                    <div class="review-list">
                        <div>
                            <div class="avg" th:text="${proRequest.proStarRate}">4.5</div>
                            <div class="review-star">
                                <ul>
                                    <li>
                                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo="
                                             alt="">
                                    </li>
                                </ul>
                                <div th:text="${proReviewCnt} + '개의 리뷰'"></div>
                            </div>
                        </div>
                        <div>
                            <ul class="review-container">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="request-price-side">
            <div class="side-wrapper">
                <div class="request-price">
                    <input type="hidden" name="userCash" th:value="${userCash}">

                    <span id="proRequestPay" th:text="${proRequest.proRequestPay}" ></span>
                    <span>원에 요청을 보내주셨습니다. 수락하시겠습니까?</span>

                    <!-- 작업이 완료 되면 띄우도록 -->
                    <!-- <span>작업이 완료 되었습니다!</span> -->
                </div>
                <div class="accept-cancle-btn">
                    <input type="hidden" name="proRequestProgress" th:value="${proRequest.proRequestProgress}">
                    <button onclick="goAccept()"
                            th:style="${proRequest.proRequestProgress != 'PRE' ? 'display:none' : ''}" type="button"
                            class="btn-accept">
                        수락하기
                    </button>
                    <button onclick="goDelete()"
                            th:style="${proRequest.proRequestProgress != 'PRE' ? 'display:none' : ''}" type="button"
                            class="btn-cancle">거절하기
                    </button>
                    <!-- 거절하기 누르면 삭제하도록 delete만들기!! -->

                    <!--  작업 완료를 눌렀다면 밑에 두개가 뜨도록 -->
                    <button onclick="goComplete()"
                            th:style="${proRequest.proRequestProgress != 'ING' ? 'display:none' : ''}" type="button"
                            class="btn-accept">작업 완료
                    </button>
                    <button th:style="${proRequest.proRequestProgress != 'ING' ? 'display:none' : ''}" type="button"
                            id="btn-modal" class="btn-cancle">취소 또는 신고
                    </button>

                    <!-- 작업 완료를 누르면 리뷰 작성하기 띄우기-->
                    <button th:unless="${proRequest.checkUserReview == 1}"
                            th:style="${proRequest.proRequestProgress != 'POST' ? 'display:none' : ''}"
                            th:onclick="|location.href='@{/user/proReview/{proRequestId}(proRequestId=${proRequest.proRequestId})}'|"
                            class="btn-accept">리뷰 작성하기
                    </button>
                    <button th:if="${proRequest.checkUserReview == 1}"
                            th:style="${proRequest.proRequestProgress != 'POST' ? 'display:none' : ''}"
                            th:onclick="|location.href='@{/user/proReview/{proRequestId}(proRequestId=${proRequest.proRequestId})}'|"
                            class="btn-accept" style="background-color: #9aa0a6 !important;" disabled>리뷰를 이미 작성하셨습니다
                    </button>

                </div>
            </div>
        </div>
    </div>
</div>


<div id="modal" class="modal-overlay">
    <div class="modal-window">
        <div class="title">
            <h2>취소하기 또는 신고하기</h2>
            <div id="close-area" class="close-area">X</div>
        </div>
        <div class="content">
            <form method="post" id="cancle-form" th:action="@{/user/accusePro}" th:object="${proAccuse}">
                <input type="hidden" name="proRequestId" th:value="${proRequest.proRequestId}">
                <div class="check-text">
                        <textarea class="form-control" rows="9"
                                  placeholder="취소또는 신고 사유" th:field="*{userAccuseContent}"></textarea>
                </div>
            </form>
        </div>
        <div class="cancle-declare-btn">
            <input type="hidden" name="proRequestId" th:value="${proRequest.proRequestId}">
            <a class="btn cancle-btn" onclick="goDelete()">취소하기</a>
            <a class="btn declar-btn" onclick="goAccuse()">신고하기</a>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  const modal = document.getElementById("modal")
  // value는 string으로 값이넘어가서, 숫자비교를 위해 형변환을 해준다
  var proRequestPay = parseInt(document.getElementById('proRequestPay').textContent);
  var userCash = parseInt(document.querySelector('input[name="userCash"]').value);

  console.log(typeof  proRequestPay+proRequestPay)
  console.log(typeof  userCash+userCash)
  function modalOn() {
    modal.style.display = "flex"

  }

  function isModalOn() {
    return modal.style.display === "flex"
  }

  function modalOff() {
    modal.style.display = "none"
  }

  const btnModal = document.getElementById("btn-modal")
  const btnModalClose = document.getElementById("close-area")
  btnModal.addEventListener("click", e => {
    modalOn()
  })
  btnModalClose.addEventListener("click", e => {
    modalOff()
  })

  function formatDate(dateString) {
    const now = new Date();
    const commentDate = new Date(dateString); // 문자열을 Date 객체로 변환

    const nowYear = now.getFullYear();
    const nowMonth = now.getMonth();
    const nowDate = now.getDate();

    const commentYear = commentDate.getFullYear();
    const commentMonth = commentDate.getMonth();
    const commentDateDate = commentDate.getDate();

    let displayText = "";

    // 년, 월, 일이 모두 같은 경우 "오늘"로 표시
    // if (nowYear === commentYear && nowMonth === commentMonth && nowDate === commentDateDate) {
    //     displayText = "오늘";
    // } else {
    // 그 외의 경우, 정해진 포맷으로 표시
    const yy = commentYear.toString().slice(-2); // 마지막 두 자리를 가지고 옴.
    const M = commentMonth + 1; // 월은 0부터 시작하므로 1을 더해줍니다.
    const d = commentDateDate;
    const HH = commentDate.getHours().toString().padStart(2, '0');
    const mm = commentDate.getMinutes().toString().padStart(2, '0'); // 두자리 수 일 때 앞에 0을 붙임.

    displayText = `${yy}.${M}.${d}`;
    // }
    return displayText;
  }

  // 리뷰 가져오기
  $(document).ready(function () {
    console.log('여기는 됨')
    // let boardId = document.querySelector('input[name="boardId"]').value;
    let proId = $('input[name="proId"]').val();
    console.log(proId)
    getReview(proId);
  })

  function getReview(proId) {
    $.ajax({
      method: 'get',
      url: '/proReviews/' + proId,
      success: function (data) {
        let reviewListArea = $('.review-container')

        reviewListArea.empty();

        data.forEach(function (review) {
          let reviewDate = formatDate(review.proReviewDate);


          // 종합적으로 뿌려줄 html
          let reviewElement = `<li>
                                        <div class="reviewr-name">
                                            <span>${review.userName}</span>
                                        </div>
                                        <div class="service-score">
                                            <p>${review.proReviewTitle}</p>
                                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Im03LjQ5NiAxLjU5NiAxLjQwNyAyLjc0MiAzLjE0NS40NGMuOTEuMTI3IDEuMjc1IDEuMjA0LjYxNSAxLjgyMmwtMi4yNzYgMi4xMzQuNTM4IDMuMDE1Yy4xNTUuODcyLS43OTcgMS41MzgtMS42MTIgMS4xMjZMNi41IDExLjQ1MmwtMi44MTMgMS40MjNjLS44MTUuNDEyLTEuNzY3LS4yNTQtMS42MTItMS4xMjZsLjUzOC0zLjAxNUwuMzM3IDYuNmMtLjY2LS42MTgtLjI5Ni0xLjY5NS42MTUtMS44MjJsMy4xNDUtLjQ0IDEuNDA3LTIuNzQyQzUuOTEyLjggNy4wODguOCA3LjQ5NiAxLjU5NiIgZmlsbD0iI0ZGQ0UyMSIgZmlsbC1ydWxlPSJldmVub2RkIi8+Cjwvc3ZnPgo=" alt="">
                                            <span>${review.proReviewRate}</span>
                                        </div>
                                        <div class="review-content">
                                            <p>${review.proReviewContent}</p>
                                        </div>
                                        <div class="review-date">
                                            <span class="date">${reviewDate}</span>
                                        </div>
                                    </li>`

          reviewListArea.append(reviewElement);
        })
      },
      error: function (data) {
        console.error(data, "불러오기 실패");
      }
    })
  }

  function goDelete() {
    if (confirm('요청을 취소하시겠습니까?')) {
      // 사용자가 '확인'을 선택했을 경우, 삭제 절차 진행
      var proRequestId = document.querySelector('input[name="proRequestId"]').value;
      // Form을 통해 POST 요청으로 서버에 삭제를 요청하도록 변경
      var form = document.createElement('form');
      form.method = 'post';
      form.action = '/user/proDetail/delete/' + proRequestId;
      document.body.appendChild(form);
      form.submit();
    }
    // 사용자가 '취소'를 선택한 경우, 함수를 종료하고 아무것도 하지 않습니다.
  }

  // 보유캐시보다 수락할 금액이 크면 수락불가능
  function goAccept() {
        console.log(proRequestPay)
        console.log(userCash)
      if(proRequestPay>=userCash){
          alert('보유캐시가 작아 수락이 불가능합니다.캐시를 충전해주세요')
          return;

      }
      else {
          if (confirm('요청을 수락하시겠습니까?')) {
              var proRequestId = document.querySelector('input[name="proRequestId"]').value;
              var form = document.createElement('form');
              form.method = 'post';
              form.action = '/user/proDetail/updateAccept/' + proRequestId;

              document.body.appendChild(form);
              form.submit();
          }
      }
  }
  // 작업완료를 누르면 포인트가 전문가에게 전달됨,
  function goComplete() {
      var proName = $('.pro-name').text();
      console.log(proRequestPay)

    confirm((proRequestPay+'캐시가 ' + proName +' 전문가님에게 보내졌습니다.'))

    var proRequestId = document.querySelector('input[name="proRequestId"]').value;
    var form = document.createElement('form');
    form.method = 'post';
    form.action = '/user/proDetail/updateComplete/' + proRequestId;

      // input hidden 태그를 폼에 담아서 같이 금액을 넘겨줌
      const payInput = document.createElement('input')
      payInput.type='hidden'
      payInput.name='proRequestPay'
      payInput.value=proRequestPay.toString()
      form.appendChild(payInput)
    document.body.appendChild(form);
    form.submit();
  }

  function goAccuse() {
    var form = document.querySelector('form[id="cancle-form"]');
    form.submit();
  }

  // function btnDisabled() {
  //   const target = document.getElementById('review_btn');
  //   target.disabled = true;
  // }


</script>
<!--<script>-->
<!--  let temp = location.href.split("?");-->
<!--  let data = temp[0];-->
<!--  let value1 = data[0];-->

<!--  function btnDisabled() {-->
<!--    const target = document.getElementById('review_btn');-->
<!--    if (value1) {-->
<!--      target.disabled = true;-->
<!--    }-->
<!--  }-->
<!--</script>-->
</body>
</html>