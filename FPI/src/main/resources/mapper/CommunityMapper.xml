<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.fpi.mapper.board.CommunityMapper">

    <!--  Community  전체 목록 가져오기  -->
<!--    <select id="communitySelectAll" resultType="CommunityDTO">-->
<!--        SELECT *-->
<!--        FROM (-->
<!--                 SELECT ROWNUM AS RN, COMMUNITY.*-->
<!--                 FROM (-->
<!--                          SELECT-->
<!--                              C.COMMUNITY_ID,-->
<!--                              C.SUBJECT,-->
<!--                              C.COMMUNITY_TITLE,-->
<!--                              C.COMMUNITY_CONTENT,-->
<!--                              U.USER_NAME,-->
<!--                              C.COMMUNITY_REGISTER_DATE,-->
<!--                              C.COMMUNITY_UPDATE_DATE,-->
<!--                              U.USER_ID,-->
<!--                              C.COMMUNITY_THUMBNAIL,-->
<!--                              (SELECT COUNT(*) FROM TBL_LIKE L WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT-->
<!--                          FROM-->
<!--                              TBL_COMMUNITY C-->
<!--                                  JOIN TBL_USER U ON U.USER_ID = C.USER_ID-->
<!--                          WHERE-->
<!--                              C.SUBJECT IN ('자유게시판', '전문가팁')-->
<!--                          ORDER BY-->
<!--                              C.COMMUNITY_UPDATE_DATE DESC-->
<!--                      ) COMMUNITY-->
<!--        WHERE ROWNUM &lt;= #{endRow}-->
<!--        )-->
<!--        WHERE rn &gt; #{startRow}-->
<!--    </select>-->








<!--    <select id="communitySelectAll" resultType="CommunityDTO">-->
<!--        SELECT *-->
<!--        FROM (-->
<!--                 SELECT ROWNUM AS RN, COMMUNITY.*-->
<!--                 FROM (-->
<!--                          SELECT-->
<!--                              C.COMMUNITY_ID,-->
<!--                              C.SUBJECT,-->
<!--                              C.COMMUNITY_TITLE,-->
<!--                              C.COMMUNITY_CONTENT,-->
<!--                              U.USER_NAME,-->
<!--                              C.COMMUNITY_REGISTER_DATE,-->
<!--                              C.COMMUNITY_UPDATE_DATE,-->
<!--                              U.USER_ID,-->
<!--                              C.COMMUNITY_THUMBNAIL,-->
<!--                              (SELECT COUNT(*) FROM TBL_LIKE L  WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT-->
<!--                          FROM-->
<!--                              TBL_COMMUNITY C JOIN TBL_USER U-->
<!--                                               ON-->
<!--                                                   U.USER_ID = C.USER_ID-->
<!--                        <where>-->
<!--                            <if test="search != null">-->
<!--                                <choose>-->
<!--                                    <when test="subject =='자유게시판'">c.subject == '자유게시판' and-->
<!--                                        (c.community_content LIKE '%' || #{search} || '%' or c.community_title-->
<!--                                        LIKE '%' || #{search} || '%')-->
<!--                                    </when>-->
<!--                                    <when test="subject == '전문가팁'">tbl_community.subject == '전문가팁' and-->
<!--                                        (c.community_content LIKE '%' || #{search} || '%' or c.community_title-->
<!--                                        LIKE '%' || #{search} || '%')-->
<!--                                    </when>-->
<!--                                    <otherwise>-->
<!--                                        c.community_content LIKE '%' || #{search} || '%' or c.community_title-->
<!--                                        LIKE '%' || #{search} || '%'-->
<!--                                    </otherwise>-->
<!--                                </choose>-->
<!--                            </if>-->
<!--                        </where>-->
<!--                          ORDER BY-->
<!--                              C.COMMUNITY_UPDATE_DATE DESC-->
<!--                      ) COMMUNITY-->
<!--                 WHERE ROWNUM &lt;= #{endRow}-->
<!--             )-->
<!--        WHERE rn &gt; #{startRow}-->
<!--    </select>-->


    <select id="communitySelectAll" resultType="CommunityDTO">
        SELECT *
        FROM (
        SELECT ROWNUM AS RN, COMMUNITY.*
        FROM (
        SELECT
        C.COMMUNITY_ID,
        C.SUBJECT,
        C.COMMUNITY_TITLE,
        C.COMMUNITY_CONTENT,
        U.USER_NAME,
        C.COMMUNITY_REGISTER_DATE,
        C.COMMUNITY_UPDATE_DATE,
        U.USER_ID,
        C.COMMUNITY_THUMBNAIL,
        (SELECT COUNT(*) FROM TBL_LIKE L WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT
        FROM
        TBL_COMMUNITY C
        JOIN
        TBL_USER U ON U.USER_ID = C.USER_ID
        <where>
            <if test="search != null and search != ''">
                <choose>
                    <when test="subject != null and subject == '자유게시판'">
                        C.SUBJECT = '자유게시판' AND
                        (C.COMMUNITY_CONTENT LIKE '%' || #{search} || '%'
                        OR C.COMMUNITY_TITLE LIKE '%' || #{search} || '%')
                    </when>
                    <when test="subject != null and subject == '전문가팁'">
                        C.SUBJECT = '전문가팁' AND
                        (C.COMMUNITY_CONTENT LIKE '%' || #{search} || '%'
                        OR C.COMMUNITY_TITLE LIKE '%' || #{search} || '%')
                    </when>
                    <otherwise>
                        (C.COMMUNITY_CONTENT LIKE '%' || #{search} || '%'
                        OR C.COMMUNITY_TITLE LIKE '%' || #{search} || '%')
                    </otherwise>
                </choose>
            </if>
            <if test="search == null or search == ''">
                <choose>
                    <when test="subject != null and subject == '자유게시판'">
                        C.SUBJECT = '자유게시판'
                    </when>
                    <when test="subject != null and subject == '전문가팁'">
                        C.SUBJECT = '전문가팁'
                    </when>
                    <otherwise>
                        1 = 1 <!-- Always true, acts as a fallback to include all rows when no subject filter is applied -->
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY
        C.COMMUNITY_UPDATE_DATE DESC
        ) COMMUNITY
        WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RN &gt; #{startRow}
    </select>




    <!--  자유게시판 목록 가져오기  -->
<!--    <select id="SelectBoardList" resultType="CommunityDTO">-->
<!--        SELECT *-->
<!--        FROM (-->
<!--                 SELECT ROWNUM AS RN, COMMUNITY.*-->
<!--                 FROM (-->
<!--                          SELECT-->
<!--                              C.COMMUNITY_ID,-->
<!--                              C.SUBJECT,-->
<!--                              C.COMMUNITY_TITLE,-->
<!--                              C.COMMUNITY_CONTENT,-->
<!--                              U.USER_NAME,-->
<!--                              C.COMMUNITY_REGISTER_DATE,-->
<!--                              C.COMMUNITY_UPDATE_DATE,-->
<!--                              U.USER_ID,-->
<!--                              (SELECT COUNT(*) FROM TBL_LIKE L  WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT-->
<!--                          FROM-->
<!--                              TBL_COMMUNITY C JOIN TBL_USER U-->
<!--                                                   ON-->
<!--                                                       U.USER_ID = C.USER_ID-->
<!--                          where c.subject = '자유게시판'-->
<!--                          ORDER BY-->
<!--                              C.COMMUNITY_UPDATE_DATE DESC-->
<!--                      ) COMMUNITY-->
<!--                 WHERE ROWNUM &lt;= #{endRow}-->
<!--             )-->
<!--        WHERE rn &gt; #{startRow}-->
<!--    </select>-->

<!--    &lt;!&ndash;  전문가팁 목록 가져오기  &ndash;&gt;-->
<!--    <select id="SelectProTipList" resultType="CommunityDTO">-->
<!--        SELECT *-->
<!--        FROM (-->
<!--                 SELECT ROWNUM AS RN, COMMUNITY.*-->
<!--                 FROM (-->
<!--                          SELECT-->
<!--                              C.COMMUNITY_ID,-->
<!--                              C.SUBJECT,-->
<!--                              C.COMMUNITY_TITLE,-->
<!--                              C.COMMUNITY_CONTENT,-->
<!--                              U.USER_NAME,-->
<!--                              C.COMMUNITY_REGISTER_DATE,-->
<!--                              C.COMMUNITY_UPDATE_DATE,-->
<!--                              U.USER_ID,-->
<!--                              (SELECT COUNT(*) FROM TBL_LIKE L  WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT-->
<!--                          FROM-->
<!--                              TBL_COMMUNITY C JOIN TBL_USER U-->
<!--                                                   ON-->
<!--                                                       U.USER_ID = C.USER_ID-->
<!--                          where c.subject = '전문가팁'-->
<!--                          ORDER BY-->
<!--                              C.COMMUNITY_UPDATE_DATE DESC-->
<!--                      ) COMMUNITY-->
<!--                 WHERE ROWNUM &lt;= #{endRow}-->
<!--             )-->
<!--        WHERE rn &gt; #{startRow}-->
<!--    </select>-->




    <!-- community 총 게시글의 갯수  -->
<!--    <select id="countCommunity">-->
<!--        select count(*)-->
<!--        from tbl_Community-->
<!--        <where>-->
<!--            <if test="search != null">-->
<!--                <choose>-->
<!--                    <when test="subject =='자유게시판'">tbl_community.subject == '자유게시판' and-->
<!--                        (tbl_community.community_content LIKE '%' || #{search} || '%' or tbl_community.community_title-->
<!--                        LIKE '%' || #{search} || '%')-->
<!--                    </when>-->
<!--                    <when test="subject == '전문가팁'">tbl_community.subject == '전문가팁' and-->
<!--                        (tbl_community.community_content LIKE '%' || #{search} || '%' or tbl_community.community_title-->
<!--                        LIKE '%' || #{search} || '%')-->
<!--                    </when>-->
<!--                    <otherwise>-->
<!--                        tbl_community.community_content LIKE '%' || #{search} || '%' or tbl_community.community_title-->
<!--                        LIKE '%' || #{search} || '%'-->
<!--                    </otherwise>-->
<!--                </choose>-->
<!--            </if>-->
<!--        </where>-->
<!--    </select>-->
    <select id="countCommunity">
        SELECT COUNT(*)
        FROM tbl_Community
        WHERE
        <choose>
            <when test="subject == '자유게시판'">
                subject = '자유게시판'
            </when>
            <when test="subject == '전문가팁'">
                subject = '전문가팁'
            </when>
            <otherwise>
                subject IN ('자유게시판', '전문가팁')
            </otherwise>
        </choose>
    </select>
















    <!--  community 게시글 상세보기  -->
    <select id="selectCommunityDetail" resultType="CommunityDetailDTO">
        SELECT
            C.COMMUNITY_ID,
            C.SUBJECT,
            C.COMMUNITY_TITLE,
            C.COMMUNITY_CONTENT,
            U.USER_NAME,
            C.Community_REGISTER_DATE,
            C.COMMUNITY_UPDATE_DATE,
            U.USER_ID,
            (SELECT COUNT(*) FROM TBL_LIKE L  WHERE L.COMMUNITY_ID = C.COMMUNITY_ID) AS LIKE_COUNT
        FROM
            TBL_COMMUNITY C JOIN TBL_USER U ON U.USER_ID = C.USER_ID
        where C.COMMUNITY_ID = #{communityId}
    </select>

<!--    insert에 사용    -->
    <select id="getSeq" resultType="long">
        select SEQ_COMMUNITY.nextval from dual
    </select>
<!--    작성  -->
    <insert id="saveCommunity">
        insert into TBL_COMMUNITY
        values(#{communityId}, #{subject}, #{communityTitle},#{communityContent}, sysdate, sysdate, #{userId}, #{communityThumbnail})
    </insert>

<!--    게시글 수정-->
    <update id="editCommunity">
        update tbl_community
        set SUBJECT=#{subject},COMMUNITY_TITLE =#{communityTitle}, COMMUNITY_CONTENT =#{communityContent},COMMUNITY_UPDATE_DATE = sysdate ,COMMUNITY_THUMBNAIL=#{communityThumbnail}
        where community_id = #{communityId}
    </update>

<!--    게시글 삭제-->
    <delete id="deleteCommunity">
        delete from TBL_COMMUNITY
        where COMMUNITY_ID = #{communityId}
    </delete>

<!--    해당 게시글 좋아요 한적있는지 조회-->
    <select id="selectLike">
        select LIKE_ID
        from TBL_LIKE
        where USER_ID=#{userId} and COMMUNITY_ID=#{communityId}
    </select>

<!--                        좋아요 테이블                                  -->
    <insert id="insertLike">
        insert into TBL_LIKE
        values (#{likeId},#{userId},#{communityId})
    </insert>
    <select id="getLikeSeq" resultType="long">
        select SEQ_LIKE.nextval from dual
    </select>
    <delete id="deleteLike">
        delete from TBL_LIKE
        where LIKE_ID=#{likeId}
    </delete>


<!--    최근 게시글 4개뿌려주기,메인에서 사용-->
    <select id="communityList" resultType="CommunityDTO">
         SELECT ROWNUM AS RN, COMMUNITY.*
         FROM (
                  SELECT
                      C.COMMUNITY_ID,
                      C.SUBJECT,
                      C.COMMUNITY_TITLE,
                      C.COMMUNITY_CONTENT,
                      C.COMMUNITY_REGISTER_DATE,
                      C.COMMUNITY_UPDATE_DATE,
                      C.COMMUNITY_THUMBNAIL,
                      u.USER_NAME
                  FROM
                      TBL_COMMUNITY C join TBL_USER u
                    on c.USER_ID = u.USER_ID
                  ORDER BY
                      C.COMMUNITY_UPDATE_DATE DESC
              ) COMMUNITY
         WHERE ROWNUM &lt;= 4

    </select>

</mapper>